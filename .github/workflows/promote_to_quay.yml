# Promote to Quay Workflow
# ========================
# Progressive promotion: Copy tested GHCR image to Quay.io on release tags.
# This ensures the exact same image (digest) that was tested on main is promoted.
#
# Release flow:
# 1. Developer creates git tag (v1.2.3) pointing to tested commit
# 2. This workflow triggers and looks up sha-<commit> image in GHCR
# 3. Verifies source signature (proves image was built by trusted workflow)
# 4. Copies image + signatures + attestations to Quay (cosign copy)
# 5. Re-signs on Quay (adds release workflow identity)
#
# Benefits:
# - No rebuild: exact bit-for-bit parity between dev and prod
# - Fast releases: copy is instant vs. minutes for multi-arch builds
# - Lower costs: no compute time for rebuilding
# - Audit trail: production image provenance traces to original build
#
# IMPORTANT: Images must be built on main BEFORE creating release tag.
# The workflow looks up sha-<tag_commit> which must exist in GHCR.

name: Promote to Quay

on:
  # Trigger on semantic version tags only (e.g., v1.0.0, v2.1.3)
  push:
    tags: ['v*.*.*']
  # Manual trigger with optional SHA override
  # Useful for promoting a specific commit that differs from tag commit
  workflow_dispatch:
    inputs:
      source_sha:
        description: 'Source commit SHA to promote (defaults to tag commit)'
        required: false
        type: string

# Empty permissions: each job requests only what it needs
permissions: {}

# Cancel-in-progress: false - releases should complete once started
# Unlike CI, we don't want newer tags to cancel in-flight releases
concurrency:
  group: promote-to-quay-${{ github.ref }}
  cancel-in-progress: false

jobs:
  promote-compass:
    uses: ./.github/workflows/reusable_promote.yml
    with:
      source_registry: ghcr.io
      source_image: complytime/complybeacon-compass
      # sha- prefix matches the tag format from publish_images.yml
      # Uses workflow_dispatch input if provided, otherwise tag's commit SHA
      source_tag: sha-${{ inputs.source_sha || github.sha }}
      dest_registry: quay.io
      # dest_tag from git ref_name (e.g., "v1.2.3" from "refs/tags/v1.2.3")
      dest_tag: ${{ github.ref_name }}
      # Auto-create 1.2 and 1 tags from v1.2.3 for floating version support
      create_semver_tags: true
      # SECURITY: Verify GHCR signature before promotion
      # Prevents promoting unsigned/tampered images
      verify_source_signature: true
      # Identity must match this repo's workflows (not just any org workflow)
      allowed_identity_regex: https://github.com/${{ github.repository }}(/.*)?
    secrets:
      dest_username: ${{ secrets.QUAY_USERNAME }}
      dest_password: ${{ secrets.QUAY_PASSWORD }}

  # Re-sign on Quay: adds release workflow identity to the image
  # Why re-sign? The original signature proves "built on main by publish workflow"
  # The new signature proves "released by promote workflow" - different claims
  sign-compass:
    needs: promote-compass
    permissions:
      packages: write   # Push signature to Quay
      id-token: write   # OIDC token for keyless signing
    uses: ./.github/workflows/reusable_sign_and_verify.yml
    with:
      image_name: quay.io/complytime/complybeacon-compass
      digest: ${{ needs.promote-compass.outputs.digest }}
      allowed_identity_regex: https://github.com/${{ github.repository }}(/.*)?
      # verify_attestations: false because SBOM/provenance are from GHCR build
      # The attestations are copied but their signatures reference GHCR identity
      # We only verify the image signature which we just created
      verify_attestations: false
    secrets:
      quay_username: ${{ secrets.QUAY_USERNAME }}
      quay_password: ${{ secrets.QUAY_PASSWORD }}

  promote-beacon-distro:
    uses: ./.github/workflows/reusable_promote.yml
    with:
      source_registry: ghcr.io
      source_image: complytime/complybeacon-beacon-distro
      source_tag: sha-${{ inputs.source_sha || github.sha }}
      dest_registry: quay.io
      dest_tag: ${{ github.ref_name }}
      create_semver_tags: true
      verify_source_signature: true
      allowed_identity_regex: https://github.com/${{ github.repository }}(/.*)?
    secrets:
      dest_username: ${{ secrets.QUAY_USERNAME }}
      dest_password: ${{ secrets.QUAY_PASSWORD }}

  sign-beacon-distro:
    needs: promote-beacon-distro
    permissions:
      packages: write
      id-token: write
    uses: ./.github/workflows/reusable_sign_and_verify.yml
    with:
      image_name: quay.io/complytime/complybeacon-beacon-distro
      digest: ${{ needs.promote-beacon-distro.outputs.digest }}
      allowed_identity_regex: https://github.com/${{ github.repository }}(/.*)?
      verify_attestations: false
    secrets:
      quay_username: ${{ secrets.QUAY_USERNAME }}
      quay_password: ${{ secrets.QUAY_PASSWORD }}
