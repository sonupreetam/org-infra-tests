# Reusable Vulnerabilities Scan Workflow
# ======================================
# - OSV-Scanner: Google's Open Source Vulnerabilities database for dependency CVEs
# - Trivy Source: Filesystem scan for vulnerabilities and secrets in source code
# - Trivy Image: Container image scan for OS packages and runtime dependencies

name: Reusable Vulnerabilities Scan

on:
  workflow_call:
    inputs:
      enable_osv:
        description: 'Enable OSV dependency scanning'
        required: false
        type: boolean
        default: true
      enable_trivy_source:
        description: 'Enable Trivy source scan (filesystem vulnerabilities)'
        required: false
        type: boolean
        default: false
      enable_secret_scan:
        description: 'Enable secret detection in Trivy source scan (requires enable_trivy_source)'
        required: false
        type: boolean
        default: true
      enable_trivy_image:
        description: 'Enable Trivy image vulnerability scan (requires image_ref)'
        required: false
        type: boolean
        default: false
      path:
        description: 'Path to scan for source scans'
        required: false
        type: string
        default: '.'
      skip_dirs:
        description: 'Comma-separated directories to skip in source scan'
        required: false
        type: string
        default: 'node_modules,.git,vendor,dist,.venv'
      image_ref:
        description: 'Image reference for image scan, e.g., ghcr.io/org/image:sha-<sha>'
        required: false
        type: string
        default: ''
      trivy_severity:
        description: 'Severity levels to fail/report'
        required: false
        type: string
        default: 'HIGH,CRITICAL'
      ignore_unfixed:
        description: 'Ignore unfixed vulnerabilities (vuln scans)'
        required: false
        type: boolean
        default: true
      upload_sarif:
        description: 'Upload SARIF results to code scanning'
        required: false
        type: boolean
        default: true
      fail_on_vuln:
        description: 'Fail the job when findings are detected'
        required: false
        type: boolean
        default: true
      scan-args:
        description: 'Additional arguments to pass to osv-scanner'
        required: false
        type: string

permissions:
  contents: read
  issues: none
  pull-requests: none
  actions: none
  security-events: none

# Prevent duplicate scans for the same ref
concurrency:
  group: reusable-vuln-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate_inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate image_ref when trivy image scan enabled
        if: ${{ inputs.enable_trivy_image && inputs.image_ref == '' }}
        run: |
          echo "::error::enable_trivy_image is true but image_ref is not provided"
          exit 1

  call_ext_osv_scanner:
    name: OSV-Scanner
    # https://google.github.io/osv-scanner/github-action/
    uses: google/osv-scanner-action/.github/workflows/osv-scanner-reusable-pr.yml@375a0e8ebdc98e99b02ac4338a724f5750f21213 # v2.3.1
    permissions:
      contents: read
      actions: read
      security-events: write
    with:
      scan-args: "${{ inputs.scan-args }}"
      fail-on-vuln: true
      upload-sarif: true
      results-file-name: osv-scanner-pr-results-${{ github.workflow_sha }}-${{ github.run_number }}.sarif
