# Reusable Sign and Verify Workflow
# ==================================
# Implements keyless container image signing using Sigstore/Cosign.
# Always verifies ALL attestations (security-in-depth, no opt-out).
#
# Prerequisites (run these workflows first):
#   1. reusable_publish_ghcr.yml - creates image with SBOM + SLSA provenance attestations
#   2. reusable_vuln_scan.yml    - attaches vuln attestation
#
# Attestations verified (mandatory):
#   - signature:       Keyless signature via Sigstore
#   - slsaprovenance:  Build provenance (from docker/build-push-action)
#   - spdx:            SBOM (from docker/build-push-action)
#   - vuln:            Vulnerability scan results (from reusable_vuln_scan.yml)

name: Reusable Sign and Verify

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Full image name (e.g., ghcr.io/org/image)'
        required: true
        type: string
      digest:
        description: 'Pushed image digest to sign/verify'
        required: true
        type: string
      allowed_identity_regex:
        description: 'Regex for Cosign certificate identity (optional, defaults to org-level)'
        required: false
        type: string
      sign_environment:
        description: 'Environment name to gate signing (for required reviewers)'
        required: false
        type: string
        default: 'signing'
    secrets:
      quay_username:
        description: 'Quay.io username/robot for login (only needed if signing quay.io images)'
        required: false
      quay_password:
        description: 'Quay.io password/token for login (only needed if signing quay.io images)'
        required: false
    outputs:
      digest:
        description: 'Signed image digest (same as input, for chaining)'
        value: ${{ jobs.sign-and-verify.outputs.digest }}
      image:
        description: 'Image reference that was signed/verified'
        value: ${{ jobs.sign-and-verify.outputs.image }}

permissions:
  packages: none
  id-token: none

concurrency:
  # Use digest (fixed length) instead of image_name (variable, could be long)
  group: reusable-sign-verify-${{ inputs.digest }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sign-and-verify:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      packages: write   # Push signature as OCI artifact to registry
      id-token: write   # Request OIDC token for keyless signing via Sigstore
    outputs:
      digest: ${{ steps.output.outputs.digest }}
      image: ${{ steps.output.outputs.image }}

    environment: ${{ inputs.sign_environment }}
    steps:
      # Registry authentication for signature push
      - name: Log in to GHCR
        if: contains(inputs.image_name, 'ghcr.io')
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Quay
        if: contains(inputs.image_name, 'quay.io')
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: quay.io
          username: ${{ secrets.quay_username }}
          password: ${{ secrets.quay_password }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign image
        env:
          IMAGE_NAME: ${{ inputs.image_name }}
          DIGEST: ${{ inputs.digest }}
        run: |
          echo "Signing: ${IMAGE_NAME}@${DIGEST}"
          cosign sign --yes "${IMAGE_NAME}@${DIGEST}"

      - name: Verify signature
        id: output
        env:
          IMAGE: ${{ inputs.image_name }}@${{ inputs.digest }}
          IDENTITY_REGEX: ${{ inputs.allowed_identity_regex || format('https://github.com/{0}/.*', github.repository_owner) }}
        run: |
          cosign verify \
            --certificate-identity-regexp="$IDENTITY_REGEX" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            "$IMAGE" >/dev/null

          echo "digest=${{ inputs.digest }}" >> "$GITHUB_OUTPUT"
          echo "image=${{ inputs.image_name }}" >> "$GITHUB_OUTPUT"

      - name: Verify SLSA provenance
        env:
          IMAGE: ${{ inputs.image_name }}@${{ inputs.digest }}
          IDENTITY_REGEX: ${{ inputs.allowed_identity_regex || format('https://github.com/{0}/.*', github.repository_owner) }}
        run: |
          cosign verify-attestation --type slsaprovenance \
            --certificate-identity-regexp="$IDENTITY_REGEX" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            "$IMAGE" >/dev/null

      - name: Verify SBOM
        env:
          IMAGE: ${{ inputs.image_name }}@${{ inputs.digest }}
          IDENTITY_REGEX: ${{ inputs.allowed_identity_regex || format('https://github.com/{0}/.*', github.repository_owner) }}
        run: |
          cosign verify-attestation --type spdx \
            --certificate-identity-regexp="$IDENTITY_REGEX" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            "$IMAGE" >/dev/null

      - name: Verify vuln attestation
        env:
          IMAGE: ${{ inputs.image_name }}@${{ inputs.digest }}
          IDENTITY_REGEX: ${{ inputs.allowed_identity_regex || format('https://github.com/{0}/.*', github.repository_owner) }}
        run: |
          cosign verify-attestation --type vuln \
            --certificate-identity-regexp="$IDENTITY_REGEX" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            "$IMAGE" >/dev/null
