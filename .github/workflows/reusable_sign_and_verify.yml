# Reusable Sign and Verify Workflow
# ==================================
# Signs container images with Sigstore keyless signing and verifies all attestations.
#
# Prerequisites (attestations must exist before calling this workflow):
#   - SLSA provenance: from reusable_push_ghcr.yml (actions/attest-build-provenance)
#   - SBOM:            from reusable_push_ghcr.yml (actions/attest-sbom)
#   - Vuln scan:       from reusable_vuln_scan.yml (cosign attest --type vuln)
#
# Security guarantees:
#   - All attestations are Sigstore-signed with Rekor transparency log
#   - Certificate identity and OIDC issuer are verified
#   - Workflow fails if ANY attestation is missing or invalid

name: Reusable Sign and Verify

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Full image name (e.g., ghcr.io/org/image)'
        required: true
        type: string
      digest:
        description: 'Image digest to sign/verify (sha256:...)'
        required: true
        type: string
      allowed_identity_regex:
        description: 'Certificate identity regex for Sigstore verification (e.g., https://github.com/org/repo/.github/workflows/reusable_.*)'
        required: true
        type: string
      sign_environment:
        description: 'Environment for signing approval gates'
        required: false
        type: string
        default: ''
    secrets:
      quay_username:
        description: 'Quay.io username (only for quay.io images)'
        required: false
      quay_password:
        description: 'Quay.io password (only for quay.io images)'
        required: false
    outputs:
      digest:
        description: 'Signed image digest'
        value: ${{ jobs.sign-and-verify.outputs.digest }}
      image:
        description: 'Signed image reference'
        value: ${{ jobs.sign-and-verify.outputs.image }}

permissions:
  contents: none
  packages: none
  id-token: none

concurrency:
  group: sign-verify-${{ inputs.digest }}
  cancel-in-progress: true

jobs:
  sign-and-verify:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      packages: write   # Push signature to registry
      id-token: write   # OIDC token for keyless signing
    environment: ${{ inputs.sign_environment || null }}
    outputs:
      digest: ${{ inputs.digest }}
      image: ${{ inputs.image_name }}

    env:
      IMAGE: ${{ inputs.image_name }}@${{ inputs.digest }}
      IDENTITY: ${{ inputs.allowed_identity_regex }}
      OIDC_ISSUER: https://token.actions.githubusercontent.com

    steps:
      - name: Log in to GHCR
        if: contains(inputs.image_name, 'ghcr.io')
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Quay
        if: contains(inputs.image_name, 'quay.io')
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: quay.io
          username: ${{ secrets.quay_username }}
          password: ${{ secrets.quay_password }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign image
        run: cosign sign --yes "$IMAGE"

      - name: Verify signature
        run: cosign verify --certificate-identity-regexp="$IDENTITY" --certificate-oidc-issuer="$OIDC_ISSUER" "$IMAGE"

      - name: Verify SLSA provenance
        run: cosign verify-attestation --type https://slsa.dev/provenance/v1 --certificate-identity-regexp="$IDENTITY" --certificate-oidc-issuer="$OIDC_ISSUER" "$IMAGE"

      - name: Verify SBOM
        run: cosign verify-attestation --type https://spdx.dev/Document/v2.3 --certificate-identity-regexp="$IDENTITY" --certificate-oidc-issuer="$OIDC_ISSUER" "$IMAGE"

      - name: Verify vulnerability scan
        run: cosign verify-attestation --type vuln --certificate-identity-regexp="$IDENTITY" --certificate-oidc-issuer="$OIDC_ISSUER" "$IMAGE"
